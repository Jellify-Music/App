name: Reusable Setup and Test

on:
  workflow_call:
    inputs:
      runner:
        description: 'Runner to use (ubuntu-latest or macos-15)'
        required: false
        type: string
        default: 'ubuntu-latest'
      skip-tests:
        description: 'Skip running tests'
        required: false
        type: boolean
        default: false

jobs:
  setup-and-test:
    runs-on: ${{ inputs.runner }}
    steps:
      - name: 🛒 Checkout
        uses: actions/checkout@v4

      - name: 🖥 Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 📦 Install Bun
        run: npm i -g bun

      - name: 💬 Echo package.json version to Github ENV
        run: echo VERSION_NUMBER=$(node -p -e "require('./package.json').version") >> $GITHUB_ENV

      - name: 📦 Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: 📥 Install dependencies
        run: bun install

      - name: 🔍 Run TypeScript check
        if: ${{ !inputs.skip-tests }}
        run: bun run tsc

      - name: 🧪 Run tests
        if: ${{ !inputs.skip-tests }}
        run: bun test

      - name: 🦋 Check formatting
        if: ${{ !inputs.skip-tests }}
        run: bun run format:check
