name: Publish Android APK and TestFlight Betas
on:
  workflow_dispatch:
    inputs:
        build-platform:
          description: 'Select the platform to build'
          required: true
          default: 'Both'
          type: choice
          options:
            - Android
            - iOS
            - Both

        version-bump:
          description: 'Version bump type'
          required: true
          default: 'No Bump'
          type: choice
          options:
            - No Bump
            - minor
            - patch
            - major
    
jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.ai_release_notes.outputs.release_notes }}
    steps:
      - name: üõí Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SIGNING_REPO_PAT }}
          fetch-depth: 0

      - name: üß† Collect commit messages
        id: commits
        run: |
          git fetch --tags --quiet

          # Find the latest tag reachable from current HEAD
          LAST_TAG=$(git describe --tags --abbrev=0)

          # Get all non-merge commit messages since that tag
          COMMIT_MESSAGES=$(git log --no-merges --pretty=format:"- %s" "${LAST_TAG}..HEAD")

          # Output for GitHub Actions
          {
            echo "messages<<EOF"
            echo "$COMMIT_MESSAGES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"


          
      - name: ‚ú® Generate release notes with ChatGPT
        id: ai_release_notes
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          MESSAGES=$(cat <<EOF
          ${{ steps.commits.outputs.messages }}
          EOF
          )
          
          JSON=$(jq -n \
            --arg commits "$MESSAGES" \
            '{
              model: "gpt-4o",
              temperature: 0.7,
              messages: [
                {"role": "system", "content": "You are a React Native developer named Violet that is writing concise and friendly mobile app release notes from commit messages."},
                {"role": "system", "content": "You are writing release notes for a mobile app called Jellify. The app is a music player that allows you to play music from your Jellyfin media server and stream music from the internet."},
                {"role": "system", "content": "You are a music enthusiast and you love music related puns and jokes. You can lightly add a pun or joke to the release notes if it's relevant to the release."},
                {"role": "system", "content": "Release notes should be concise and helpful to any user of the app - regardless of their technical knowledge."},
                {"role": "system", "content": "Release notes should be written in a way that is easy to understand and follow, and engaging and entertaining to read."},
                {"role": "user", "content": ("Write a release summary based on these commit messages:\n" + $commits)}
              ]
          }')
          
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON")
      
          RELEASE_BODY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
      
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  publish-android:
    if: ${{ github.event.inputs['build-platform'] == 'Android' || github.event.inputs['build-platform'] == 'Both' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.setver.outputs.version }}
    steps:
      - name: üõí Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SIGNING_REPO_PAT }}
      
      - name: üñ• Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: üíé Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
            ruby-version: '3.0'  
            bundler-cache: true

      - name: üçé Run yarn init-android
        run: yarn install --network-concurrency 1

      - name: + Version Up
        if: ${{ github.event.inputs['version-bump'] != 'No Bump' }}
        run: yarn react-native bump-version --type ${{ github.event.inputs['version-bump'] }} 
      
      - id: setver
        run: echo "version=$(node -p -e "require('./package.json').version")" >> $GITHUB_OUTPUT

      
      - name: üí¨ Echo package.json version to Github ENV
        run: echo VERSION_NUMBER=$(node -p -e "require('./package.json').version") >> $GITHUB_ENV
      
      - name: ü§´ Output TelemetryDeck Secrets to TelemetryDeck.json          
        run: |
          echo "{" > telemetrydeck.json
          echo "\"appID\": \"${{ secrets.TELEMETRYDECK_APPID }}\"," >> telemetrydeck.json
          echo "\"clientUser\": \"anonymous\"," >> telemetrydeck.json
          echo "\"app\": \"Jellify\"" >> telemetrydeck.json
          echo "}" >> telemetrydeck.json

          
      - name: ü§´ Output Glitchtip Secrets to Glitchtip.json
        run: |
          echo "{" > glitchtip.json
          echo "\"dsn\": \"${{ secrets.GLITCHTIP_DSN }}\"" >> glitchtip.json
          echo "}" >> glitchtip.json
      
      - name: ‚úÖ Validate Config Files
        run: |
          node -e "JSON.parse(require('fs').readFileSync('telemetrydeck.json'))"
          node -e "JSON.parse(require('fs').readFileSync('glitchtip.json'))"
    
      - name: üöÄ Run Android fastlane build
        run: yarn fastlane:android:build
      
      - name: üì§ Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: ./android/app/build/outputs/apk/release/*.apk


  publish-iOS:
    if: ${{ github.event.inputs['build-platform'] == 'iOS' || github.event.inputs['build-platform'] == 'Both' }}
    runs-on: macos-15
    outputs:
      version: ${{ steps.setver.outputs.version }}
    needs: [generate-release-notes]
    steps:
  
      - name: üõí Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SIGNING_REPO_PAT }}

      - name: üñ• Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üçé Run yarn init-ios:new-arch
        run: yarn init-ios:new-arch
      
      - name: + Version Up
        if: ${{ github.event.inputs['version-bump'] != 'No Bump' }}
        run: yarn react-native bump-version --type ${{ github.event.inputs['version-bump'] }}  

      - id: setver
        run: echo "version=$(node -p -e "require('./package.json').version")" >> $GITHUB_OUTPUT
          
      - name: üí¨ Echo package.json version to Github ENV
        run: echo VERSION_NUMBER=$(node -p -e "require('./package.json').version") >> $GITHUB_ENV
          
      - name: ü§´ Output App Store Connect API Key JSON to Fastlane
        run: echo -e '${{ secrets.APPSTORE_CONNECT_API_KEY_JSON }}' > appstore_connect_api_key.json
        working-directory: ./ios/fastlane

      - name: ü§´ Output TelemetryDeck Secrets to TelemetryDeck.json          
        run: |
          echo "{" > telemetrydeck.json
          echo "\"appID\": \"${{ secrets.TELEMETRYDECK_APPID }}\"," >> telemetrydeck.json
          echo "\"clientUser\": \"anonymous\"," >> telemetrydeck.json
          echo "\"app\": \"Jellify\"" >> telemetrydeck.json
          echo "}" >> telemetrydeck.json

          
      - name: ü§´ Output Glitchtip Secrets to Glitchtip.json
        run: |
          echo "{" > glitchtip.json
          echo "\"dsn\": \"${{ secrets.GLITCHTIP_DSN }}\"" >> glitchtip.json
          echo "}" >> glitchtip.json
                
      - name: ‚úÖ Validate Config Files
        run: |
          node -e "JSON.parse(require('fs').readFileSync('telemetrydeck.json'))"
          node -e "JSON.parse(require('fs').readFileSync('glitchtip.json'))"
                    
      - name: üöÄ Run iOS fastlane build and publish to TestFlight
        run: yarn fastlane:ios:beta
        env:
          APPSTORE_CONNECT_API_KEY_JSON: ${{ secrets.APPSTORE_CONNECT_API_KEY_JSON }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_REPO_PAT: "anultravioletaurora:${{ secrets.SIGNING_REPO_PAT }}"

      - name: üì§ Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: ./ios/Jellify.ipa

  finalize-release:
    needs: [publish-android, publish-iOS, generate-release-notes]
    runs-on: ubuntu-latest
    steps:
      - name: üõí Checkout Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SIGNING_REPO_PAT }}
      - name: üíé Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0' 
          bundler-cache: true

      - name: ‚¨áÔ∏è Download Android Artifacts
        if: ${{ github.event.inputs['build-platform'] == 'Android' || github.event.inputs['build-platform'] == 'Both' }}
        uses: actions/download-artifact@v4
        with:
          name: android-artifacts
          path: artifacts/

      - name: ‚¨áÔ∏è Download iOS Artifacts
        if: ${{ github.event.inputs['build-platform'] == 'iOS' || github.event.inputs['build-platform'] == 'Both' }}
        uses: actions/download-artifact@v4
        with:
          name: ios-artifacts
          path: artifacts/
      
      - name: üî¢ Set artifact version numbers
        run: |
          VERSION=${{ needs.publish-ios.outputs.version || needs.publish-android.outputs.version }}
          mkdir final-artifacts

          # Rename IPA
          if [ -f artifacts/ios-artifacts/Jellify.ipa ]; then
            cp artifacts/ios-artifacts/Jellify.ipa "final-artifacts/Jellify-${VERSION}.ipa"
          fi

          # Rename APKs
          if [ -d artifacts/android-artifacts ]; then
            for apk in artifacts/android-artifacts/*.apk; do
              filename=$(basename "$apk")
              cp "$apk" "final-artifacts/Jellify-${VERSION}-${filename}"
            done
          fi

      - name: üî¢ Commit version bump if any
        if: ${{ github.event.inputs['version-bump'] != 'No Bump' }}
        run: |
          git config --global user.name "anultravioletaurora"
          git config --global user.email "violet@jellify.app"
          git add package.json ios/Jellify.xcodeproj/project.pbxproj android/app/build.gradle || true
          git commit -m "[skip actions] version bump" || echo "No changes to commit"
          git pull origin main
          git push origin main

      - name: üéâ Create Unified GitHub Release
        uses: ncipollo/release-action@v1
        id: githubRelease
        with:
          artifacts: ./final-artifacts/*
          name: ${{ needs.publish-ios.outputs.version || needs.publish-android.outputs.version }}
          tag: ${{ needs.publish-ios.outputs.version || needs.publish-android.outputs.version }}
          body: ${{ needs.generate-release-notes.outputs.release_notes }}
          prerelease: true
          token: ${{ secrets.SIGNING_REPO_PAT }}

      - name: üó£Ô∏è Notify on Discord
        run: |
          cd ios
          bundle install && bundle exec fastlane notifyOnDiscord
          cd ..
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          APP_VERSION: ${{ needs.publish-ios.outputs.version || needs.publish-android.outputs.version }}
          release_url: ${{ steps.githubRelease.outputs.html_url }}